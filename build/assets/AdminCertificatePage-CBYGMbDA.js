import{A as P,aM as ze,a1 as te,aN as re,ap as ae,j as e,M as He,l as c,Y as C,T as l,a3 as oe,a2 as R,g as j,a8 as ie,aa as se,a9 as Re,i as Ke,r as Ue,d as f,G as J,aO as Ee}from"./index-0GGCgQc5.js";import{A as ne,u as Me}from"./get-all-certificates-for-admin.query-BotWsGC0.js";import{u as Te,o as Ve}from"./yup-l7oKxK6W.js";import{u as le}from"./useMutation-DW6lAXSi.js";import{C as ce,a as Le,S as qe,V as We,b as Oe}from"./ConfirmDialog-CW7dtUG5.js";import{I as _e}from"./InputAdornment-BltocGSA.js";import{A as X}from"./Alert-DH6aySMM.js";import{T as Qe,a as Ne,b as Ye,c as Z,d as m,e as $e,f as Ge}from"./TableRow-BfCpx3__.js";import{C as Je}from"./Chip-BUZF0xjW.js";import{D as Xe}from"./Delete-CS6izGUm.js";const Ze=()=>{const{show:a}=P();return{download:async t=>{var i,n,h;try{const d=await ze.downloadCertificate(t),v=window.URL.createObjectURL(new Blob([d])),u=document.createElement("a");u.href=v,u.setAttribute("download",`certificate-${t}.pdf`),document.body.appendChild(u),u.click(),(i=u.parentNode)==null||i.removeChild(u),window.URL.revokeObjectURL(v),a({title:"Certificate download initiated!",color:"Success"})}catch(d){console.error("Failed to download certificate:",d),a({title:((h=(n=d==null?void 0:d.response)==null?void 0:n.data)==null?void 0:h.message)||"Failed to download certificate.",color:"Error"})}}}},et=()=>{const{show:a}=P(),s=te();return le({mutationFn:async t=>(await re.createCertificate(t)).data,onSuccess:()=>{s.invalidateQueries({queryKey:[ne]}),a({title:"Certificate created successfully",color:"Success"})},onError:t=>{var i,n;a({title:((n=(i=t.response)==null?void 0:i.data)==null?void 0:n.message)||"Failed to create certificate.",color:"Error"})}})},tt=()=>{const a=te(),{show:s}=P();return le({mutationFn:async t=>(await re.softDeleteCertificate(t)).data,onSuccess:()=>{a.invalidateQueries({queryKey:[ne]}),s({title:"Certificate deleted successfully",color:"Success"})},onError:t=>{var i,n;s({title:((n=(i=t.response)==null?void 0:i.data)==null?void 0:n.message)||"Failed to delete certificate.",color:"Error"})}})},rt=ae(e.jsx("path",{d:"M5 20h14v-2H5zM19 9h-4V3H9v6H5l7 7z"}),"Download"),K=ae(e.jsx("path",{d:"M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2m-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5zm5 2c0 .83-.67 1.5-1.5 1.5h-2.5V7H15c.83 0 1.5.67 1.5 1.5zm4-3H19v1h1.5V11H19v2h-1.5V7h3zM9 9.5h1v-1H9zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4zm10 5.5h1v-3h-1z"}),"PictureAsPdf"),at={position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:{xs:"90%",sm:"70%",md:"50%"},bgcolor:"background.paper",borderRadius:"1rem",boxShadow:24,p:{xs:2,sm:4},outline:"none",maxHeight:"90vh",overflowY:"auto"},ot=({open:a,onClose:s,certificate:t,loading:i})=>{const{download:n}=Ze(),h=()=>{t!=null&&t.certificateKey&&n(t.certificateKey)};return e.jsx(He,{open:a,onClose:s,"aria-labelledby":"certificate-detail-modal-title","aria-describedby":"certificate-detail-modal-description",children:e.jsxs(c,{sx:at,children:[e.jsx(C,{"aria-label":"close",onClick:s,sx:{position:"absolute",right:8,top:8,color:d=>d.palette.grey[500]},children:e.jsx(ce,{})}),e.jsx(l,{id:"certificate-detail-modal-title",variant:"h5",component:"h2",gutterBottom:!0,children:"Certificate Details"}),i?e.jsx(c,{sx:{display:"flex",justifyContent:"center",py:4},children:e.jsx(oe,{})}):t?e.jsxs(R,{elevation:0,sx:{p:2,mt:2,bgcolor:"#f8fafc"},children:[e.jsxs(l,{variant:"body1",color:"text.secondary",children:[e.jsx("strong",{children:"Key:"})," ",t.certificateKey]}),e.jsxs(l,{variant:"body1",color:"text.secondary",sx:{mt:1},children:[e.jsx("strong",{children:"PDF URL:"})," ",e.jsx("a",{href:t.pdfUrl,target:"_blank",rel:"noopener noreferrer",style:{wordBreak:"break-all"},children:t.pdfUrl})]}),e.jsxs(l,{variant:"body1",color:"text.secondary",sx:{mt:1},children:[e.jsx("strong",{children:"Status:"})," ",t.isActive?"Active":"Inactive"]}),t.uploadedBy&&typeof t.uploadedBy=="object"&&e.jsxs(l,{variant:"body1",color:"text.secondary",sx:{mt:1},children:[e.jsx("strong",{children:"Uploaded By:"})," ",t.uploadedBy.name," (",t.uploadedBy.email,")"]}),e.jsxs(l,{variant:"body1",color:"text.secondary",sx:{mt:1},children:[e.jsx("strong",{children:"Uploaded At:"})," ",new Date(t.createdAt).toLocaleString()]}),e.jsxs(l,{variant:"body1",color:"text.secondary",sx:{mt:1},children:[e.jsx("strong",{children:"Last Updated:"})," ",new Date(t.updatedAt).toLocaleString()]}),e.jsx(j,{variant:"contained",color:"primary",startIcon:e.jsx(rt,{}),onClick:h,sx:{mt:3},children:"Download PDF"})]}):e.jsx(l,{variant:"body1",color:"text.secondary",children:"No certificate data available."})]})})},ee={padding:"0.75rem 1.25rem",borderRadius:"0.5rem",cursor:"pointer",fontSize:"1rem",fontWeight:600,transition:"all 0.2s ease-in-out",border:"1px solid transparent",display:"flex",alignItems:"center",justifyContent:"center",gap:"0.5rem",fontFamily:'"Inter", sans-serif',whiteSpace:"nowrap",textTransform:"none"},o={container:{maxWidth:"1200px",margin:{xs:"1rem",md:"2rem auto"},padding:{xs:"1rem",md:"1.5rem"},backgroundColor:"#ffffff",borderRadius:"1rem",boxShadow:"0 10px 30px rgba(0, 0, 0, 0.08)"},header:{marginBottom:"1.5rem",color:"#1e293b",textAlign:"center",fontSize:{xs:"1.75rem",md:"2.25rem"},fontWeight:700},subHeader:{marginBottom:"1.5rem",color:"#334155",fontSize:{xs:"1.5rem",md:"1.75rem"},fontWeight:600},formContainer:{padding:{xs:"1rem",md:"2rem"},borderRadius:"0.75rem",backgroundColor:"#f8fafc",marginBottom:"2rem"},pdfUploadContainer:{marginBottom:"1.5rem",display:"flex",flexDirection:"column",alignItems:"flex-start",gap:"1rem"},uploadButton:{...ee,backgroundColor:"#e0f2fe",color:"#0288d1",border:"1px solid #90caf9","&:hover":{backgroundColor:"#90caf9",color:"#ffffff"}},submitButton:{...ee,backgroundColor:"#10b981",color:"#ffffff","&:hover":{backgroundColor:"#059669"},"&:disabled":{backgroundColor:"#a7f3d0",color:"#ffffff",cursor:"not-allowed"}},alert:{marginBottom:"1rem",borderRadius:"0.5rem"},searchAndSwitchContainer:{display:"flex",justifyContent:"flex-end",marginBottom:"1.5rem",gap:"1rem",flexWrap:"wrap","@media (max-width: 600px)":{flexDirection:"column",alignItems:"stretch"}},searchField:{width:"300px","@media (max-width: 600px)":{width:"100%"}},loadingBox:{display:"flex",justifyContent:"center",paddingY:"2rem"},tableContainer:{boxShadow:"0 4px 20px rgba(0, 0, 0, 0.05)",borderRadius:"0.75rem",overflow:"scroll"},tableHeader:{fontWeight:700,backgroundColor:"#f8fafc",color:"#334155",whiteSpace:"nowrap",padding:"1rem"},tableRow:{"&:nth-of-type(odd)":{backgroundColor:"#fefefe"},"&:hover":{backgroundColor:"#f0f4f8"}},tableCell:{color:"#475569",padding:"0.75rem 1rem"},tablePdfIcon:{fontSize:"1.5rem",color:"#dc2626"},tableActions:{display:"flex",justifyContent:"flex-end",gap:"0.5rem","& .MuiIconButton-root":{padding:"6px","&:hover":{backgroundColor:"rgba(0, 0, 0, 0.04)"}}}},it=ie().shape({certificatePdf:Re().test("fileType","Unsupported File Format. Only PDFs are allowed.",a=>a?a instanceof File&&a.type==="application/pdf":!0).test("fileSize","PDF must be less than 10MB.",a=>a?a instanceof File&&a.size<=10*1024*1024:!0).required("Certificate PDF is required for creation"),email:se().email("Invalid email").required("Email is required")});ie().shape({searchKey:se().trim().required("Please enter a certificate key to search").min(5,"Key must be at least 5 characters long")});var U={},st=Ke;Object.defineProperty(U,"__esModule",{value:!0});var E=U.default=void 0,nt=st(Ue()),lt=e;E=U.default=(0,nt.default)((0,lt.jsx)("path",{d:"M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"}),"ContentCopy");const ct=Ee`
  from {
    opacity: 0;
    transform: translateY(-40px);
  }
  to {
    opacity: 1;
    transform: translateY(0px);
  }
`,dt=({pdfName:a,certKey:s,onCopyKey:t,onClose:i,isCopyDisabled:n})=>e.jsx(c,{sx:{p:3,border:"1px solid #e0e0e0",borderRadius:2,background:"#fafbfc",minWidth:260,display:"flex",flexDirection:"column",alignItems:"flex-start",gap:2,animation:`${ct} 0.5s cubic-bezier(0.4,0,0.2,1)`},children:s?e.jsxs(e.Fragment,{children:[e.jsx(l,{variant:"h6",sx:{fontWeight:600},children:"Certificate Info"}),e.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(K,{color:"error"}),e.jsx(l,{variant:"body2",children:a})]}),s&&e.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(l,{variant:"body2",sx:{fontWeight:500},children:"Key:"}),e.jsx(l,{variant:"body2",sx:{fontFamily:"monospace"},children:s})]}),e.jsxs(c,{sx:{display:"flex",gap:1,mt:1},children:[e.jsx(j,{variant:"outlined",size:"small",startIcon:e.jsx(E,{}),onClick:t,disabled:n,children:"Copy Cert Key"}),e.jsx(j,{variant:"outlined",size:"small",color:"error",onClick:i,children:"Close"})]})]}):e.jsx(l,{variant:"h6",sx:{fontWeight:600},children:"Upload a certificate to see the details"})}),ft=()=>{var _,Q,N,Y,$;const[a,s]=f.useState(null),[t,i]=f.useState(null),[n,h]=f.useState(null),d=f.useRef(null),[v,u]=f.useState(!1),[de,fe]=f.useState(null),[xe,k]=f.useState(!1),[M,D]=f.useState(null),[T,V]=f.useState(0),[L,me]=f.useState(10),[b,ue]=f.useState(""),[pe,he]=f.useState(""),{data:p,isLoading:be,isError:ge,error:A,refetch:ye}=Me({page:T+1,limit:L,search:b}),w=et(),I=tt(),{show:F}=P(),{handleSubmit:Ce,reset:B,setValue:g,formState:{errors:S,isSubmitting:q,isValid:je},register:W}=Te({resolver:Ve(it),defaultValues:{certificatePdf:void 0,email:""}});f.useEffect(()=>{const r=setTimeout(()=>{he(b)},500);return()=>clearTimeout(r)},[b]),f.useEffect(()=>{B(),i(null),s(null),g("certificatePdf",null)},[B,g]);const z=()=>{s(null),i(null),h(null),g("certificatePdf",null),d.current&&(d.current.value="")},ve=r=>{if(r.target.files&&r.target.files[0]){const x=r.target.files[0];s(x),i(x.name),g("certificatePdf",x),h(null)}else z()},we=async r=>{var y;if(!a){F({title:"Please select a PDF file for the certificate.",color:"Error"});return}const x=await w.mutateAsync({pdfFile:a,email:r.email});B(),s(null),i(null),g("certificatePdf",null),d.current&&(d.current.value=""),(y=x==null?void 0:x.certificate)!=null&&y.certificateKey&&(h(x.certificate.certificateKey),i(a.name))},Se=r=>{fe(r),u(!0)},Pe=r=>{D(r),k(!0)},ke=async()=>{M&&(await I.mutateAsync(M),k(!1),D(null),ye())},De=()=>{k(!1),D(null)},Ae=(r,x)=>{V(x)},Ie=r=>{me(parseInt(r.target.value,10)),V(0)},O=((_=p==null?void 0:p.data)==null?void 0:_.certificates)||[],Fe=O.filter(r=>{var y,G;const x=b.toLowerCase().trim();return((y=r.certificateKey)==null?void 0:y.toLowerCase().includes(x))||((G=r.userEmail)==null?void 0:G.toLowerCase().includes(x))}),Be=((N=(Q=p==null?void 0:p.data)==null?void 0:Q.certificates)==null?void 0:N.length)||0,H=pe?Fe:(Y=p==null?void 0:p.data)==null?void 0:Y.certificates;return e.jsxs(c,{sx:o.container,children:[e.jsx(l,{variant:"h4",component:"h1",sx:o.header,children:"Add New Certificate"}),e.jsxs(c,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},gap:3,alignItems:"flex-start",mb:3},children:[e.jsx(R,{elevation:3,sx:{...o.formContainer,flex:1,minHeight:280,display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",background:"#fafbfc",border:"1px solid #e0e0e0",boxShadow:"0 2px 8px rgba(0,0,0,0.04)"},children:e.jsxs("form",{onSubmit:Ce(we),style:{width:"100%"},children:[e.jsx(J,{...W("email"),label:"Email",variant:"outlined",size:"small",error:!!S.email,helperText:($=S.email)==null?void 0:$.message,sx:{mb:2}}),e.jsxs(c,{sx:{...o.pdfUploadContainer,width:"100%"},children:[e.jsx("input",{accept:"application/pdf",style:{display:"none"},id:"certificate-pdf-upload",type:"file",...W("certificatePdf",{onChange:ve}),ref:d}),e.jsx("label",{htmlFor:"certificate-pdf-upload",children:e.jsx(j,{variant:"outlined",component:"span",startIcon:e.jsx(Le,{}),sx:o.uploadButton,disabled:w.isPending||!!a,children:"Upload PDF"})}),S.certificatePdf&&e.jsx(l,{color:"error",variant:"caption1",sx:{mt:1},children:S.certificatePdf.message})]}),a&&t&&e.jsxs(c,{sx:{mt:2,mb:1,p:1.5,border:"1px solid #e0e0e0",borderRadius:2,background:"#f9f9f9",position:"relative",display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(K,{color:"error"}),e.jsx("a",{href:URL.createObjectURL(a),target:"_blank",rel:"noopener noreferrer",style:{textDecoration:"underline",color:"#1976d2",fontWeight:500,wordBreak:"break-all"},children:t}),e.jsx(C,{size:"small",sx:{position:"absolute",top:4,right:4,background:"#fff",boxShadow:1},onClick:z,"aria-label":"Remove PDF",children:e.jsx(ce,{fontSize:"small"})})]}),e.jsx(j,{type:"submit",variant:"contained",color:"primary",sx:{...o.submitButton,mt:2},disabled:!je||q||w.isPending||!a,loading:q||w.isPending,children:"Upload Certificate"})]})}),e.jsx(c,{sx:{minWidth:280,minHeight:280,flex:1,display:"flex",alignItems:"center",justifyContent:"center",background:"#fafbfc",border:"1px solid #e0e0e0",boxShadow:"0 2px 8px rgba(0,0,0,0.04)",borderRadius:2,ml:{md:.5},mt:{xs:2,md:0}},children:e.jsx(dt,{pdfName:t,certKey:n,onCopyKey:()=>{n&&(navigator.clipboard.writeText(n),F({title:"Certificate key copied to clipboard",color:"Success"}))},onClose:z,isCopyDisabled:!n})})]}),e.jsxs(c,{sx:{mt:4},children:[e.jsx(l,{variant:"h5",component:"h2",sx:o.subHeader,children:"Existing Certificates"}),e.jsx(c,{sx:o.searchAndSwitchContainer,children:e.jsx(J,{label:"Search by Key",variant:"outlined",size:"small",value:b,onChange:r=>ue(r.target.value),InputProps:{startAdornment:e.jsx(_e,{position:"start",children:e.jsx(qe,{})})},sx:o.searchField})}),be?e.jsx(c,{sx:o.loadingBox,children:e.jsx(oe,{})}):ge?e.jsxs(X,{severity:"error",sx:o.alert,children:["Error loading certificates: ",A==null?void 0:A.message]}):O.length===0?e.jsx(X,{severity:"info",sx:o.alert,children:"No certificates found."}):e.jsxs(Qe,{component:R,sx:o.tableContainer,children:[e.jsxs(Ne,{children:[e.jsx(Ye,{children:e.jsxs(Z,{children:[e.jsx(m,{sx:o.tableHeader,children:"Key"}),e.jsx(m,{sx:o.tableHeader,children:"PDF"}),e.jsx(m,{sx:o.tableHeader,children:"User"}),e.jsx(m,{sx:o.tableHeader,children:"Status"}),e.jsx(m,{sx:o.tableHeader,align:"right",children:"Actions"})]})}),e.jsx($e,{children:H==null?void 0:H.map(r=>e.jsxs(Z,{sx:o.tableRow,children:[e.jsxs(m,{sx:o.tableCell,children:[r.certificateKey,e.jsx(C,{onClick:()=>{navigator.clipboard.writeText(r.certificateKey),F({title:"Certificate key copied to clipboard",color:"Success"})},children:e.jsx(E,{fontSize:"small"})})]})," ",e.jsx(m,{sx:o.tableCell,children:e.jsxs("a",{href:r.pdfUrl,target:"_blank",rel:"noopener noreferrer",style:{display:"flex",alignItems:"center",gap:"0.5rem",wordBreak:"break-all"},children:[e.jsx(K,{sx:o.tablePdfIcon}),"View PDF"]})}),e.jsx(m,{sx:o.tableCell,children:r.userEmail}),e.jsx(m,{sx:o.tableCell,children:e.jsx(Je,{label:r.isActive?"Active":"Inactive",color:r.isActive?"success":"error"})}),e.jsx(m,{align:"right",sx:o.tableCell,children:e.jsxs(c,{sx:o.tableActions,children:[e.jsx(C,{size:"small",onClick:()=>Se(r),"aria-label":"view certificate",children:e.jsx(We,{fontSize:"small"})}),e.jsx(C,{size:"small",onClick:()=>Pe(r.certificateKey),"aria-label":"delete certificate",disabled:I.isPending||!r.isActive,children:e.jsx(Xe,{fontSize:"small"})})]})})]},r._id))})]}),e.jsx(Ge,{rowsPerPageOptions:[5,10,25],component:"div",count:Be,rowsPerPage:L,page:T,onPageChange:Ae,onRowsPerPageChange:Ie})]})]}),e.jsx(ot,{open:v,onClose:()=>u(!1),certificate:de,loading:!1}),e.jsx(Oe,{open:xe,onClose:De,onConfirm:ke,title:"Confirm Deletion",description:"Are you sure you want to soft-delete this certificate? It will become inactive.",loading:I.isPending})]})},vt=()=>e.jsx(ft,{});export{vt as AdminCertificatePage};
